# media -> <your_app_name>

steps:
  - name: gcr.io/cloud-builders/gcloud
    entrypoint: 'bash'
    args: [ '-c', 'gcloud secrets versions access latest --secret=dockerhub-vonicvn > decrypted-data.txt' ]

  - name: "gcr.io/cloud-builders/docker"
    entrypoint: 'bash'
    args: ["-c", "docker login --username=vonicvn --password-stdin < decrypted-data.txt"]

  - name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "vonicvn/media:$REVISION_ID", "."]

  - name: "gcr.io/cloud-builders/docker"
    args: ["push", "vonicvn/media:$REVISION_ID"]

  - name: "gcr.io/cloud-builders/gcloud"
    args:
      [
        "compute","ssh","jasontran@services","--zone=asia-east1-b","--force-key-file-overwrite",
        "--command=docker pull vonicvn/media:$REVISION_ID && docker service update media_app --image vonicvn/media:$REVISION_ID"
      ]